import{r as l,j as e}from"./index-DLBiUv4k.js";import"./vendor-BtP0CW_r.js";const be=({token:x,apiBase:u,product:m,onCancel:oe,onSaved:U})=>{const[E,q]=l.useState(""),[C,Q]=l.useState(""),[$,L]=l.useState(""),[_,ne]=l.useState([]),[k,W]=l.useState(""),[R,G]=l.useState("0"),[O,K]=l.useState(""),[V,M]=l.useState(!0),[j,X]=l.useState(null),[d,Z]=l.useState({}),[A,v]=l.useState([]),[de,J]=l.useState([]),[z,Y]=l.useState(""),[T,B]=l.useState("#000000"),[ee,te]=l.useState("0"),[D,re]=l.useState("detalles"),[se,I]=l.useState(!1),b=t=>({...t?{Authorization:`Bearer ${t}`}:{}}),ce=t=>{if(t===""||t==null)return"";const o=Number(t);return Number.isNaN(o)?"":o.toLocaleString("es-CO",{style:"currency",currency:"COP"})},F=t=>{const s=String(t).replace(/[^0-9.,]/g,"").replace(",",".").split(".");return s.length>2?s[0]+"."+s.slice(1).join(""):(s[1]&&(s[1]=s[1].slice(0,2)),s.join("."))},le=t=>t?t.startsWith("http://")||t.startsWith("https://")?t:t.startsWith("/")?`${u}${t}`:t.startsWith("media/")?`${u}/${t}`:`${u}/media/${t}`:"",ae=({multiple:t=!1,accept:o="image/*",onFiles:s})=>{const[c,i]=l.useState(!1),a=l.useRef(null),g=()=>{a.current&&a.current.click()},h=r=>{const w=Array.from(r.target.files||[]);s&&s(w)},f=r=>{r.preventDefault(),i(!1);const w=Array.from(r.dataTransfer.files||[]);s&&s(w)},S=r=>{r.preventDefault(),i(!0)},N=()=>{i(!1)};return e.jsxs("div",{className:`w-full rounded-lg border-2 border-dashed ${c?"border-blue-500 bg-blue-500/10":"border-gray-600"} p-4 flex items-center justify-center cursor-pointer transition`,onClick:g,onDrop:f,onDragOver:S,onDragLeave:N,children:[e.jsxs("div",{className:"flex items-center gap-3 text-gray-300",children:[e.jsx("svg",{className:"w-6 h-6 text-blue-400",viewBox:"0 0 24 24",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M19 13H5v-2h14v2zm-7 8l-5-5h3V8h4v8h3l-5 5zM16 1H8v2h8V1z"})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{children:"Arrastra y suelta archivos aquí"}),e.jsx("div",{className:"text-xs text-gray-400",children:"o haz clic para seleccionar"})]})]}),e.jsx("input",{ref:a,type:"file",accept:o,multiple:t,className:"hidden",onChange:h})]})};l.useEffect(()=>{x&&(async()=>{I(!0);try{const s=await(await fetch(`${u}/products/categories/?page_size=100`,{headers:b(x)})).json(),c=Array.isArray(s.results)?s.results:[];ne(c),c.length>0&&!$&&L(String(c[0].id))}catch{}finally{I(!1)}})()},[x]),l.useEffect(()=>{(async()=>{if(m){I(!0),q(m.name||""),Q(String(m.price||"")),L(String(m.category||"")),W(m.sku||""),G(String(m.inventory_qty||"0")),K(m.description||""),M(!!m.active),X(null);try{const s=await(await fetch(`${u}/products/${m.id}/colors/`,{headers:b(x)})).json(),c=Array.isArray(s.results)?s.results:s,i=(Array.isArray(c)?c:[]).map((a,g)=>({id:a.id,name:a.name,hex:a.hex,stock:String(a.stock||"0"),position:g,images:[]}));for(let a=0;a<i.length;a++){const g=i[a],f=await(await fetch(`${u}/products/colors/${g.id}/images/`,{headers:b(x)})).json(),S=Array.isArray(f.results)?f.results:f;i[a]={...g,images:(Array.isArray(S)?S:[]).map((N,r)=>({id:N.id,image:N.image,position:r}))}}v(i),J(i)}catch{v([]),J([])}finally{I(!1)}}})()},[m]);const me=()=>{const t={};/^[A-Za-z0-9ÁÉÍÓÚáéíóúÑñ\-\s]{1,100}$/.test(E)||(t.name="Nombre requerido, máx 100 y sin caracteres inválidos.");const s=F(C),c=Number(s);(!s||Number.isNaN(c)||c<=0)&&(t.price="Precio debe ser positivo con 2 decimales."),O.length>500&&(t.description="Descripción máximo 500 caracteres."),_.find(a=>String(a.id)===String($))||(t.category="Debe seleccionar una categoría válida."),k&&!/^[A-Za-z0-9\-]{1,50}$/.test(k)&&(t.sku="SKU inválido (alfanumérico y guiones).");const i=Number(R);return(!Number.isInteger(i)||i<0)&&(t.inventoryQty="Cantidad debe ser entero positivo."),j&&(["image/jpeg","image/png","image/webp"].includes(j.type)||(t.image="Formato de imagen inválido (jpeg, png, webp).")),A.some(a=>!a.name||!/^#[0-9A-Fa-f]{6}$/.test(a.hex)||Number(a.stock)<0||!Number.isInteger(Number(a.stock)))&&(t.colors="Verifique nombre, HEX (#RRGGBB) y stock entero positivo de los colores."),Z(t),Object.keys(t).length===0},ge=async t=>{if(t.preventDefault(),!me())return;const o=new FormData;o.append("name",E),o.append("price",F(C)),o.append("category",$),o.append("sku",k),o.append("inventory_qty",String(Number(R))),o.append("description",O),o.append("active",V?"true":"false"),j&&o.append("image",j);const s=m?`${u}/products/${m.id}/`:`${u}/products/`,i=await fetch(s,{method:m?"PATCH":"POST",headers:b(x),body:o}),a=await i.json();if(!i.ok){const g=a.detail||(m?"No se pudo actualizar el producto":"No se pudo crear el producto");Z(h=>({...h,form:g}));return}try{const g=m?m.id:a.id,h=de,f=A.map((r,w)=>({...r,position:w})),S=new Set(h.filter(r=>r.id).map(r=>String(r.id))),N=new Set(f.filter(r=>r.id).map(r=>String(r.id)));for(const r of h)r.id&&!N.has(String(r.id))&&await fetch(`${u}/products/colors/${r.id}/`,{method:"DELETE",headers:b(x)});for(let r of f){if(r.id){const n=h.find(y=>String(y.id)===String(r.id))||{};if(n.name!==r.name||n.hex!==r.hex||String(n.stock)!==String(r.stock)||Number(n.position)!==Number(r.position)){const y=new FormData;y.append("name",r.name),y.append("hex",r.hex),y.append("stock",String(Number(r.stock||0))),y.append("position",String(r.position)),r.id&&await fetch(`${u}/products/colors/${r.id}/`,{method:"PATCH",headers:b(x),body:y})}}else{const n=new FormData;n.append("name",r.name),n.append("hex",r.hex),n.append("stock",String(Number(r.stock||0))),n.append("position",String(r.position));const p=await fetch(`${u}/products/${g}/colors/`,{method:"POST",headers:b(x),body:n}),y=await p.json();p.ok&&y&&y.id&&(r={...r,id:y.id})}if(!r.id)continue;const H=await(await fetch(`${u}/products/colors/${r.id}/images/`,{headers:b(x)})).json(),P=Array.isArray(H.results)?H.results:H,ie=Array.isArray(r.images)?r.images.map((n,p)=>({...n,position:p})):[],xe=new Set((Array.isArray(P)?P:[]).map(n=>String(n.id))),ue=new Set(ie.filter(n=>n.id).map(n=>String(n.id)));for(const n of Array.isArray(P)?P:[])ue.has(String(n.id))||await fetch(`${u}/products/color-images/${n.id}/`,{method:"DELETE",headers:b(x)});for(const n of ie)if(!n.id&&n.file){const p=new FormData;p.append("image",n.file),p.append("position",String(n.position)),await fetch(`${u}/products/colors/${r.id}/images/`,{method:"POST",headers:b(x),body:p})}else if(n.id){const p=new FormData;p.append("position",String(n.position)),await fetch(`${u}/products/color-images/${n.id}/`,{method:"PATCH",headers:b(x),body:p})}}}catch{}U&&U()};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 relative",children:[se&&e.jsx("div",{className:"absolute inset-0 z-50 bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"bg-gray-800/80 border border-white/10 rounded-xl p-6 shadow-xl text-center",children:[e.jsx("div",{className:"mx-auto w-12 h-12 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"}),e.jsx("div",{className:"mt-3 text-white font-medium",children:"Cargando datos..."}),e.jsx("div",{className:"text-xs text-gray-300",children:"Por favor espera"})]})}),e.jsxs("div",{className:`max-w-5xl mx-auto p-6 ${se?"opacity-0":"opacity-100"} transition-opacity duration-300`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("div",{className:"text-white text-xl font-semibold",children:m?"Editar producto":"Nuevo producto"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:oe,className:"px-3 py-2 rounded bg-gray-600 hover:bg-gray-700 text-white",children:"Cancelar"}),e.jsx("button",{onClick:ge,className:"px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white",children:"Guardar"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4 border-b border-white/10",children:[e.jsx("button",{onClick:()=>re("detalles"),className:`px-4 py-2 text-sm rounded-t ${D==="detalles"?"bg-white/10 text-white border-b-2 border-blue-500":"text-gray-300 hover:text-white"}`,children:"Detalles"}),e.jsx("button",{onClick:()=>re("colores"),className:`px-4 py-2 text-sm rounded-t ${D==="colores"?"bg-white/10 text-white border-b-2 border-blue-500":"text-gray-300 hover:text-white"}`,children:"Colores"})]}),d.form&&e.jsx("div",{className:"mb-4 p-3 rounded text-sm bg-red-600/20 text-red-200 border border-red-500/40",children:d.form}),D==="detalles"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded p-4 shadow",children:[e.jsx("div",{className:"text-gray-300 text-sm mb-3",children:"Información básica"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"Nombre del producto"}),e.jsx("input",{type:"text",value:E,onChange:t=>q(t.target.value),required:!0,maxLength:100,className:`w-full px-3 py-2 rounded bg-gray-700 text-white border ${d.name?"border-red-600":"border-gray-600"} focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"Nombre del producto"}),d.name&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"Precio"}),e.jsx("input",{type:"text",value:C,onChange:t=>Q(F(t.target.value)),required:!0,className:`w-full px-3 py-2 rounded bg-gray-700 text-white border ${d.price?"border-red-600":"border-gray-600"} focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"Precio"}),e.jsx("div",{className:"text-xs text-gray-400",children:ce(C)}),d.price&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.price})]}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"Descripción del producto"}),e.jsx("textarea",{value:O,onChange:t=>K(t.target.value),maxLength:500,className:`w-full px-3 py-2 rounded bg-gray-700 text-white border ${d.description?"border-red-600":"border-gray-600"} focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"Descripción del producto",rows:4}),d.description&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.description})]})]})]}),e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded p-4 shadow",children:[e.jsx("div",{className:"text-gray-300 text-sm mb-3",children:"Clasificación e inventario"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"Categoría"}),e.jsx("select",{value:$,onChange:t=>L(t.target.value),className:`w-full px-3 py-2 rounded bg-gray-700 text-white border ${d.category?"border-red-600":"border-gray-600"} focus:outline-none focus:ring-2 focus:ring-blue-500`,children:_.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),d.category&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.category})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"SKU/Código"}),e.jsx("input",{type:"text",value:k,onChange:t=>W(t.target.value),maxLength:50,className:`w-full px-3 py-2 rounded bg-gray-700 text-white border ${d.sku?"border-red-600":"border-gray-600"} focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"SKU/Código"}),d.sku&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.sku})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"Cantidad en inventario"}),e.jsx("input",{type:"number",value:R,onChange:t=>G(t.target.value),min:0,step:1,className:`w-full px-3 py-2 rounded bg-gray-700 text-white border ${d.inventoryQty?"border-red-600":"border-gray-600"} focus:outline-none focus:ring-2 focus:ring-blue-500`,placeholder:"Cantidad en inventario"}),d.inventoryQty&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.inventoryQty})]}),e.jsx("div",{className:"md:col-span-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-gray-200",children:[e.jsx("input",{type:"checkbox",checked:V,onChange:t=>M(t.target.checked)})," Activo"]})})]})]}),e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded p-4 shadow",children:[e.jsx("div",{className:"text-gray-300 text-sm mb-3",children:"Imágenes del producto"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-start",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-gray-200 text-sm mb-1",children:"Imagen principal"}),e.jsx(ae,{accept:"image/*",multiple:!1,onFiles:t=>{const o=t[0];o&&["image/jpeg","image/png","image/webp"].includes(o.type)&&X(o)}}),d.image&&e.jsx("div",{className:"mt-1 text-xs text-red-300",children:d.image})]}),e.jsx("div",{children:j?e.jsx("img",{src:URL.createObjectURL(j),alt:"Preview",className:"w-full h-40 object-cover rounded-lg border border-gray-600"}):e.jsx("div",{className:"w-full h-40 flex items-center justify-center text-gray-400 border border-dashed border-gray-600 rounded-lg",children:"Sin imagen"})})]})]})]}),D==="colores"&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded p-4 shadow",children:[e.jsx("div",{className:"text-gray-300 text-sm mb-3",children:"Colores disponibles"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"text",value:z,onChange:t=>Y(t.target.value),placeholder:"Nombre",className:"px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 text-sm"}),e.jsx("input",{type:"color",value:T,onChange:t=>B(t.target.value),className:"rounded border border-gray-600 w-10 h-10 p-0"}),e.jsx("input",{type:"number",value:ee,onChange:t=>te(t.target.value),min:0,step:1,placeholder:"Stock",className:"px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 text-sm w-24"}),e.jsx("button",{type:"button",onClick:()=>{!z||!/^#[0-9A-Fa-f]{6}$/.test(T)||(v(t=>[...t,{name:z,hex:T,stock:ee}]),Y(""),B("#000000"),te("0"))},className:"px-3 py-2 rounded bg-green-600 hover:bg-green-700 text-white text-sm",children:"Agregar"})]}),e.jsxs("div",{className:"space-y-4",children:[A.map((t,o)=>e.jsxs("div",{className:"space-y-3 bg-gray-800/60 border border-white/10 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-4 items-center",children:[e.jsx("div",{className:"w-8 h-8 rounded shadow",style:{backgroundColor:t.hex}}),e.jsx("input",{type:"text",value:t.name,onChange:s=>v(c=>c.map((i,a)=>a===o?{...i,name:s.target.value}:i)),placeholder:"Nombre",className:"col-span-2 px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 text-sm"}),e.jsx("input",{type:"color",value:t.hex,onChange:s=>v(c=>c.map((i,a)=>a===o?{...i,hex:s.target.value}:i)),className:"rounded border border-gray-600 w-10 h-10 p-0"}),e.jsx("input",{type:"number",value:t.stock,onChange:s=>v(c=>c.map((i,a)=>a===o?{...i,stock:s.target.value}:i)),min:0,step:1,placeholder:"Stock",className:"px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 text-sm"}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx("button",{type:"button",onClick:()=>v(s=>s.filter((c,i)=>i!==o)),className:"px-2.5 py-1.5 text-xs rounded bg-red-600 hover:bg-red-700 text-white",children:"Quitar"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-gray-300 text-xs",children:"Imágenes del color (máx. 4)"}),e.jsx("div",{className:"w-64",children:e.jsx(ae,{multiple:!0,accept:"image/*",onFiles:s=>{v(c=>c.map((i,a)=>{if(a!==o)return i;const g=Array.isArray(i.images)?i.images.slice():[];for(const h of s){if(g.length>=4)break;["image/jpeg","image/png","image/webp"].includes(h.type)&&g.push({file:h,preview:URL.createObjectURL(h)})}return{...i,images:g}}))}})})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:[(t.images||[]).map((s,c)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:s.preview?s.preview:le(s.image),alt:"Color",className:"w-28 h-28 object-cover rounded-lg border border-gray-600 group-hover:ring-2 group-hover:ring-blue-500 group-hover:scale-105 transition"}),e.jsx("button",{type:"button",onClick:()=>v(i=>i.map((a,g)=>g===o?{...a,images:(a.images||[]).filter((h,f)=>f!==c)}:a)),className:"absolute top-1 right-1 px-1.5 py-0.5 text-[10px] rounded bg-red-600 text-white",children:"X"})]},`img-${c}`)),(!t.images||t.images.length===0)&&e.jsx("div",{className:"text-xs text-gray-400",children:"Sin imágenes."})]})]})]},`${t.id||"new"}-${o}`)),A.length===0&&e.jsx("div",{className:"text-xs text-gray-400",children:"Sin colores agregados."})]}),d.colors&&e.jsx("div",{className:"mt-2 text-xs text-red-300",children:d.colors})]})})]})]})};export{be as default};
