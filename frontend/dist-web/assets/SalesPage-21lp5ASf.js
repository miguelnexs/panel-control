import{r as n,j as t}from"./index-DLBiUv4k.js";import"./vendor-BtP0CW_r.js";const B=({token:u,apiBase:m,onSaleCreated:A})=>{const[D,_]=n.useState([]),[R,T]=n.useState([]),[S,x]=n.useState(null),[O,F]=n.useState(""),[h,$]=n.useState(""),[o,b]=n.useState({full_name:"",cedula:"",email:"",address:""}),[H,k]=n.useState(!1),[d,v]=n.useState([]),[c,j]=n.useState({}),[N,w]=n.useState({}),f=e=>({...e?{Authorization:`Bearer ${e}`}:{}}),[J,q]=n.useState(!1),[I,L]=n.useState(!1),P=({className:e="w-4 h-4"})=>t.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("circle",{cx:"9",cy:"19",r:"1.5",stroke:"currentColor",strokeWidth:"1.5"}),t.jsx("circle",{cx:"17",cy:"19",r:"1.5",stroke:"currentColor",strokeWidth:"1.5"}),t.jsx("path",{d:"M5 5h2l2 9h8l2-7H7",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]}),p=e=>e?e.startsWith("http://")||e.startsWith("https://")?e:e.startsWith("/")?`${m}${e}`:e.startsWith("media/")?`${m}/${e}`:`${m}/media/${e}`:"",M=(e,s)=>{if(!e)return"";const a=c[e.id]||e.colors||[],r=Array.isArray(a)?a.find(y=>String(y.id)===String(s)):null;if(!r||!r.images||r.images.length===0)return e.image?p(e.image):"";const i=r.images[0],l=typeof i=="string"?i:i.image;return l?p(l):e.image?p(e.image):""},U=async()=>{x(null);try{const e=await fetch(`${m}/products/`,{headers:f(u)}),s=await e.json();if(!e.ok)throw new Error(s.detail||"No se pudieron cargar productos");const a=(Array.isArray(s)?s:[]).filter(l=>!!l.active);_(a);const r={},i={};for(const l of a)Array.isArray(l.colors)&&l.colors.length>0&&(r[l.id]=l.colors,i[l.id]=String(l.colors[0].id));j(r),w(i)}catch(e){x({type:"error",text:e.message})}};n.useEffect(()=>{u&&(async()=>{L(!0);try{const[s,a]=await Promise.all([fetch(`${m}/products/`,{headers:f(u)}),fetch(`${m}/clients/?page_size=200`,{headers:f(u)})]),r=await s.json(),i=(Array.isArray(r)?r:[]).filter(g=>!!g.active);_(i);const l={},y={};for(const g of i)Array.isArray(g.colors)&&g.colors.length>0&&(l[g.id]=g.colors,y[g.id]=String(g.colors[0].id));j(l),w(y);const z=await a.json();T(Array.isArray(z.results)?z.results:[])}catch{}finally{L(!1)}})()},[u]);const W=D.filter(e=>{const s=O.trim().toLowerCase();return s===""||String(e.name||"").toLowerCase().includes(s)||String(e.category_name||"").toLowerCase().includes(s)}),V=async e=>{if(!c[e])try{const a=await(await fetch(`${m}/products/${e}/colors/`,{headers:f(u)})).json(),r=Array.isArray(a.results)?a.results:[];j(i=>({...i,[e]:r})),r.length>0&&w(i=>({...i,[e]:String(r[0].id)}))}catch{j(a=>({...a,[e]:[]}))}},Q=async e=>{await V(e.id);let s=N[e.id]||null;const a=c[e.id]||e.colors||[];!s&&Array.isArray(a)&&a.length>0&&(s=String(a[0].id)),v(r=>[...r,{product:e,colorId:s,quantity:1}])},C=(e,s)=>{v(a=>a.map((r,i)=>i===e?{...r,...s}:r))},G=e=>{v(s=>s.filter((a,r)=>r!==e))},E=n.useMemo(()=>d.reduce((e,s)=>e+Number(s.product.price||0)*Number(s.quantity||0),0),[d]),K=async()=>{for(const e of d){const s=Number(e.quantity||0);if(!s||s<1)return{ok:!1,msg:"Cantidad inválida"};if(e.colorId){const a=c[e.product.id]||e.product.colors||[],r=Array.isArray(a)?a.find(i=>String(i.id)===String(e.colorId)):null;if(r&&Number(r.stock||0)<s)return{ok:!1,msg:"Stock insuficiente en color"}}else if(Number(e.product.inventory_qty||0)<s)return{ok:!1,msg:"Stock insuficiente del producto"}}return{ok:!0,msg:""}},X=async()=>{if(x(null),!u){x({type:"error",text:"Sesión no válida"});return}if(!(()=>{if(h)return!0;const r=(o.full_name||"").trim().length>=3,i=/^[0-9]{6,12}$/.test((o.cedula||"").trim()),l=/^\S+@\S+\.\S+$/.test((o.email||"").trim()),y=(o.address||"").trim().length>=5;return r&&i&&l&&y})()){x({type:"error",text:"Seleccione un cliente o complete los datos del nuevo cliente"});return}const s=await K();if(!s.ok){x({type:"error",text:s.msg});return}const a={client_id:h||void 0,client_full_name:h?void 0:(o.full_name||"").trim(),client_cedula:h?void 0:(o.cedula||"").trim(),client_email:h?void 0:(o.email||"").trim(),client_address:h?void 0:(o.address||"").trim(),items:d.map(r=>({product_id:r.product.id,color_id:r.colorId?Number(r.colorId):null,quantity:Number(r.quantity)}))};try{const r=await fetch(`${m}/sales/`,{method:"POST",headers:{"Content-Type":"application/json",...f(u)},body:JSON.stringify(a)}),i=await r.json();if(!r.ok){const l=typeof i=="object"?i.detail||JSON.stringify(i):"Error desconocido";throw new Error(l)}x({type:"success",text:"Venta registrada"}),v([]),U(),A&&A()}catch(r){x({type:"error",text:r.message})}};return t.jsxs("div",{className:"space-y-4 relative",children:[I&&t.jsx("div",{className:"absolute inset-0 z-50 bg-gray-900 flex items-center justify-center",children:t.jsxs("div",{className:"bg-gray-800/80 border border-white/10 rounded-xl p-6 shadow-xl text-center",children:[t.jsx("div",{className:"mx-auto w-12 h-12 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"}),t.jsx("div",{className:"mt-3 text-white font-medium",children:"Cargando datos..."}),t.jsx("div",{className:"text-xs text-gray-300",children:"Por favor espera"})]})}),S&&t.jsx("div",{className:`p-3 rounded text-sm ${S.type==="success"?"bg-green-600/20 text-green-200 border border-green-500/40":"bg-red-600/20 text-red-200 border border-red-500/40"}`,children:S.text}),t.jsxs("div",{className:`${I?"opacity-0":"opacity-100"} transition-opacity duration-300`,children:[t.jsxs("div",{className:"bg-white/5 border border-white/10 rounded p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("div",{className:"text-white font-semibold",children:"Ventas"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:O,onChange:e=>F(e.target.value),placeholder:"Buscar producto...",className:"px-3 py-2 text-xs rounded bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"}),t.jsxs("button",{onClick:()=>q(!0),className:"relative px-3 py-2 text-xs rounded bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-2",children:[t.jsx(P,{className:"w-4 h-4"}),t.jsxs("span",{children:["Carrito · ",E.toLocaleString("es-CO",{style:"currency",currency:"COP"})]}),d.length>0&&t.jsx("span",{className:"absolute -top-2 -right-2 bg-blue-500 text-white text-[10px] rounded-full px-1 min-w-[18px] text-center",children:d.length})]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:[W.map(e=>{const s=N[e.id],a=s?M(e,s):e.image?p(e.image):"";return t.jsxs("div",{className:"bg-gradient-to-b from-gray-900 to-gray-800 border border-white/10 rounded-lg p-3 shadow transition transform hover:-translate-y-1 hover:shadow-lg",children:[t.jsx("div",{className:"aspect-square mb-2 rounded overflow-hidden",children:a?t.jsx("img",{src:a,alt:e.name,className:"w-full h-full object-cover"}):t.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-500 border border-dashed border-gray-600",children:"Sin imagen"})}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-white text-sm font-medium",children:e.name}),t.jsx("div",{className:"text-xs text-gray-400",children:e.category_name||""})]}),t.jsx("div",{className:"text-gray-200 text-sm font-semibold",children:Number(e.price).toLocaleString("es-CO",{style:"currency",currency:"COP"})})]}),Array.isArray(c[e.id])&&c[e.id].length>0?t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsx("div",{className:"flex items-center gap-1",children:c[e.id].map(r=>t.jsx("button",{onClick:()=>w(i=>({...i,[e.id]:String(r.id)})),className:`w-5 h-5 rounded-full border ${String(N[e.id])===String(r.id)?"ring-2 ring-blue-500 ring-offset-1":"border-gray-600"}`,style:{backgroundColor:r.hex},"aria-label":r.name,title:r.name},r.id))}),t.jsxs("span",{className:"text-xs text-gray-400",children:["stock: ",(c[e.id].find(r=>String(r.id)===String(N[e.id]))||{}).stock||0]})]}):t.jsx("div",{className:"mt-2 text-xs text-gray-400",children:"Color único"}),t.jsx("button",{onClick:()=>Q(e),className:"mt-3 w-full px-3 py-2 text-xs rounded bg-blue-600 hover:bg-blue-700 text-white",children:"Agregar"})]},e.id)}),W.length===0&&t.jsx("div",{className:"text-gray-400 text-sm",children:"Sin productos activos"})]})]}),J&&t.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50",children:t.jsxs("div",{className:"bg-gradient-to-b from-gray-900 to-gray-800 border border-white/10 rounded-2xl p-4 w-full max-w-3xl max-h-[85vh] flex flex-col shadow-2xl",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-white font-medium",children:[t.jsx(P,{className:"w-5 h-5"}),t.jsx("span",{children:"Carrito"})]}),t.jsx("button",{onClick:()=>q(!1),className:"px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-700 text-white",children:"Cerrar"})]}),t.jsx("div",{className:"overflow-y-auto flex-1",children:t.jsxs("div",{className:"space-y-2",children:[d.map((e,s)=>{const a=e.colorId?M(e.product,e.colorId):e.product.image?p(e.product.image):"";return t.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center bg-gray-700/40 border border-gray-600 rounded p-2",children:[t.jsx("div",{className:"col-span-1",children:a?t.jsx("img",{src:a,alt:e.product.name,className:"w-12 h-12 object-cover rounded border border-gray-600"}):t.jsx("div",{className:"w-12 h-12 flex items-center justify-center text-gray-500 border border-dashed border-gray-600 rounded",children:"—"})}),t.jsx("div",{className:"col-span-3 text-gray-200 text-sm",children:e.product.name}),t.jsxs("div",{className:"col-span-3 flex items-center gap-2",children:[t.jsxs("select",{value:e.colorId||"",onChange:r=>C(s,{colorId:r.target.value||null}),className:"flex-1 px-2 py-1 text-xs rounded bg-gray-700 text-white border border-gray-600",children:[t.jsx("option",{value:"",children:"Sin color"}),Array.isArray(c[e.product.id])&&c[e.product.id].map(r=>t.jsxs("option",{value:r.id,children:[r.name," - stock: ",r.stock]},r.id))]}),t.jsx("div",{className:"w-5 h-5 rounded border border-gray-600",style:{backgroundColor:(Array.isArray(c[e.product.id])?(c[e.product.id].find(r=>String(r.id)===String(e.colorId))||{}).hex:"#000000")||"#000000"}})]}),t.jsxs("div",{className:"col-span-3 flex items-center gap-2",children:[t.jsx("button",{onClick:()=>C(s,{quantity:Math.max(1,Number(e.quantity||1)-1)}),className:"px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-700 text-white",children:"-"}),t.jsx("input",{type:"number",min:1,value:e.quantity,onChange:r=>C(s,{quantity:Number(r.target.value)}),className:"w-16 px-2 py-1 text-xs rounded bg-gray-700 text-white border border-gray-600"}),t.jsx("button",{onClick:()=>C(s,{quantity:Number(e.quantity||0)+1}),className:"px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-700 text-white",children:"+"})]}),t.jsx("div",{className:"col-span-2 text-gray-200 text-sm text-right",children:(Number(e.product.price||0)*Number(e.quantity||0)).toLocaleString("es-CO",{style:"currency",currency:"COP"})}),t.jsx("div",{className:"col-span-12 flex items-center justify-end",children:t.jsx("button",{onClick:()=>G(s),className:"px-2 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white",children:"Quitar"})})]},`it-${s}`)}),d.length===0&&t.jsx("div",{className:"text-gray-400 text-sm",children:"No hay productos en el carrito."})]})}),t.jsx("div",{className:"border-t border-white/10 pt-3 mt-3",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"text-white font-semibold",children:["Total: ",E.toLocaleString("es-CO",{style:"currency",currency:"COP"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("select",{value:h,onChange:e=>$(e.target.value),className:"px-2 py-1 text-xs rounded bg-gray-700 text-white border border-gray-600",children:[t.jsx("option",{value:"",children:"Selecciona cliente..."}),R.map(e=>t.jsx("option",{value:e.id,children:e.full_name},e.id))]}),t.jsx("button",{onClick:()=>{b({full_name:"",cedula:"",email:"",address:""}),k(!0)},className:"px-2 py-1 text-xs rounded bg-indigo-600 hover:bg-indigo-700 text-white",children:"Nuevo cliente"}),t.jsx("button",{onClick:X,disabled:d.length===0,className:"px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-50",children:"Registrar venta"})]})]})})]})})]}),H&&t.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50",children:t.jsxs("div",{className:"bg-gray-800 border border-white/10 rounded p-4 w-full max-w-lg",children:[t.jsx("div",{className:"text-white font-medium mb-3",children:"Nuevo cliente"}),t.jsxs("form",{onSubmit:e=>{e.preventDefault(),k(!1),$("")},className:"space-y-3",children:[t.jsx("input",{type:"text",value:o.full_name,onChange:e=>b(s=>({...s,full_name:e.target.value})),placeholder:"Nombre completo",className:"w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600"}),t.jsx("input",{type:"text",value:o.cedula,onChange:e=>b(s=>({...s,cedula:e.target.value})),placeholder:"Cédula",className:"w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600"}),t.jsx("input",{type:"email",value:o.email,onChange:e=>b(s=>({...s,email:e.target.value})),placeholder:"Correo",className:"w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600"}),t.jsx("textarea",{value:o.address,onChange:e=>b(s=>({...s,address:e.target.value})),placeholder:"Dirección",className:"w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600",rows:3}),t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx("button",{type:"button",onClick:()=>k(!1),className:"px-3 py-2 rounded bg-gray-600 hover:bg-gray-700 text-white",children:"Cancelar"}),t.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white",children:"Agregar"})]})]})]})})]})};export{B as default};
